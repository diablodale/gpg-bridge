{
    // Phase 2 dev container — used by the automated integration test runner
    // (npm run test:integration via runTest.ts, which passes configFile pointing here).
    // Also available in the VS Code manual container picker.
    //
    // Phase 2: request-proxy (workspace extension) runs here; agent-proxy runs on Windows.
    //   The full chain: AssuanSocketClient → Unix socket → request-proxy → VS Code commands
    //   → agent-proxy (Windows) → gpg-agent (Windows).
    //
    // No gpg binary is needed — tests use AssuanSocketClient (raw socket I/O).
    //
    // See docs/integration-test-plan.md for details.
    "name": "gpg-windows-relay phase 2 integration tests",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:22-bookworm",
    // remoteEnv is evaluated at attach time, not container creation.
    // ${localEnv:VAR} reads from the local VS Code process env — which is the
    // @vscode/test-electron-spawned VS Code process whose env = Object.assign({},
    // process.env, extensionTestsEnv). So extensionTestsEnv values already flow here.
    //
    // VSCODE_INTEGRATION_TEST: static flag — must be 1 for full extension init.
    // TEST_KEY_FINGERPRINT / TEST_KEY_KEYGRIP: dynamic per run — generated in runTest.ts,
    //   injected into VS Code via extensionTestsEnv, resolved here via ${localEnv:...}.
    "remoteEnv": {
        "VSCODE_INTEGRATION_TEST": "1",
        "TEST_KEY_FINGERPRINT": "${localEnv:TEST_KEY_FINGERPRINT}",
        "TEST_KEY_KEYGRIP": "${localEnv:TEST_KEY_KEYGRIP}"
    },
    // node_modules directories are shadowed by container-local Docker volumes so that
    // npm install inside the container creates Linux-native symlinks without touching the
    // Windows-host node_modules (which use Windows junction paths). The workspace source
    // files and compiled out/ directories come from the normal workspace bind mount.
    // postCreateCommand runs npm install so @gpg-relay/shared symlinks resolve to
    // /workspaces/gpg-windows-relay/shared, which exists via the workspace bind mount.
    "mounts": [
        { "source": "gpg-relay-root-node-modules",    "target": "${containerWorkspaceFolder}/node_modules",               "type": "volume" },
        { "source": "gpg-relay-shared-node-modules",  "target": "${containerWorkspaceFolder}/shared/node_modules",         "type": "volume" },
        { "source": "gpg-relay-request-node-modules", "target": "${containerWorkspaceFolder}/request-proxy/node_modules",  "type": "volume" },
        { "source": "gpg-relay-agent-node-modules",   "target": "${containerWorkspaceFolder}/agent-proxy/node_modules",    "type": "volume" }
    ],
    // Only install shared and request-proxy — agent-proxy has "os": ["win32"] and
    // npm install would fail with EBADPLATFORM on Linux, aborting the whole chain.
    // agent-proxy runs on the Windows host anyway; it is not needed in the container.
    "postCreateCommand": "cd ${containerWorkspaceFolder}/shared && npm install && cd ${containerWorkspaceFolder}/request-proxy && npm install",
    "customizations": {
        "vscode": {
            "extensions": [
                // Both extensions are loaded as development extensions by the test runner;
                // no marketplace install is needed. Listed here for documentation.
                // "local.gpg-agent-proxy",   // loads on Windows (extensionKind: ui)
                // "local.gpg-request-proxy"  // loads here in container (extensionKind: workspace)
            ]
        }
    }
}
