# Hooks are installed automatically by `npm install` via the postinstall script.
# To reinstall manually:  prek install
# To bypass in an emergency: git commit --no-verify
#   Note: The GitHub repository ruleset still enforces commit signing.
#   The PR flow enforces the full test suite via CI.

default_install_hook_types:
  - pre-commit
  - commit-msg
  - pre-push
# default_stages doesn't work because repo hooks often define their stages which overrides default_stages

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: end-of-file-fixer
        stages: [pre-commit]
      - id: fix-byte-order-marker
        stages: [pre-commit]
      - id: mixed-line-ending
        args: ['--fix=lf']
        stages: [pre-commit]
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        stages: [pre-commit]

  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.30.0
    hooks:
      - id: gitleaks
        args: ['--redact', '--verbose']
        stages: [pre-commit]

  - repo: local
    hooks:
      # Prettier format
      - id: prettier
        name: Prettier
        stages: [pre-commit]
        language: system
        entry: node node_modules/prettier/bin/prettier.cjs --write
        types_or: [ts, javascript, json, yaml, markdown]
        priority: 80

      # reject tabs in most text files
      - id: reject-tabs
        name: Reject Tabs
        stages: [pre-commit]
        language: system
        types: [text]
        exclude: '^(Makefile|.*\.mk|.*\.go|.*\.tsv)$'
        entry: >
          node -e '
          const fs = require("fs");
          let failed = false;
          for (const file of process.argv.slice(1)) {
            try {
              const lines = fs.readFileSync(file, "utf8").split(/\r?\n/);
              for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes("\t")) {
                  console.error("âŒ Tab found in " + file + " on line " + (i + 1));
                  failed = true;
                  break;
                }
              }
            } catch(e) {
              console.error("âš ï¸ Error reading " + file + ": " + e.message);
              failed = true;
            }
          }
          if (failed) {
            console.error("ðŸ›‘ Commit rejected: Please fix tabs or file errors.");
            process.exit(1);
          }
          '
        priority: 90

      # pre-commit: TypeScript compile â€” must pass before lint runs
      - id: compile
        name: TypeScript compile
        stages: [pre-commit]
        language: system
        entry: npm run compile
        pass_filenames: false
        always_run: true
        priority: 100

      # pre-commit: ESLint â€” runs after compile
      - id: lint
        name: ESLint
        stages: [pre-commit]
        language: system
        entry: npm run lint
        pass_filenames: false
        always_run: true
        priority: 110

      # commit-msg: Conventional Commits format via commitlint
      - id: conventional-commits
        name: Conventional Commits
        stages: [commit-msg]
        language: system
        entry: node node_modules/@commitlint/cli/cli.js --edit
        pass_filenames: true

      # pre-push: unit tests only
      - id: tests
        name: Unit tests
        stages: [pre-push]
        language: system
        entry: npm test
        pass_filenames: false
        always_run: true
